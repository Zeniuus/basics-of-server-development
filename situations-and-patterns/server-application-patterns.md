# 서버 개발의 일반적인 어플리케이션 패턴

서버 작업을 할 때 자주 사용하게 되는 어플리케이션 패턴을 모아둔 문서이다. 항목 별로 위계가 잘 맞진 않는데, 개수가 얼마 되지 않아 하나로 모아두었다. 나중에 "어플리케이션 패턴"보다 더 정확한 용어를 깨닫게 되면 수정하려고 한다.

## API

가장 많이 사용하는 패턴이다. 서버는 네트워크를 통해 호출할 수 있는 엔드포인트를 열고, 클라이언트는 해당 API를 호출하여 원하는 목표를 달성한다. 여기서 클라이언트는 유저가 사용하는 웹이나 앱일 수도 있고, 같은 팀/회사에서 운영하는 다른 내부 서버일 수도 있고, 회사 외부의 서버일 수도 있다.

크게 두 가지 목적으로 API를 활용하는 것 같다.

- 서버가 특정 기능을 외부 클라이언트에 제공 - 일반적인 API의 목적은 이 범주에 속하게 된다. API를 호출하여 데이터를 조회/수정하거나, 특정한 연산을 할 수 있다.
- 클라이언트가 서버에게 이벤트를 전달 - API를 호출하는 쪽이 우리 서버로 무언가 전달하고 싶은 경우이다. e.g. 훅, 싱크를 위한 데이터 전달 등. 클라이언트가 서버에서 하는 일에 별로 관심이 없다는 점에서 위와 다르다.

## Job

일정 주기로 동일한 작업을 반복하는 패턴. API와 마찬가지로 상당히 많은 시나리오에서 사용할 수 있다.

- 주기적으로 통계 정보를 저장해야 하는 경우
- 특정 시각에 뭔가를 처리해야 하는 경우 - 짧은 주기로 job을 돌리면서 처리할 수 있다. (e.g. 특정 시각에 status 변경, 특정 시각에 문자 발송 등)

구현 방법에는 크게 두 가지 방법이 있다.

- API를 노출하고 외부 cron 으로 curl을 실행하여 해당 API를 주기적으로 호출하기
- 언어나 서버 프레임워크 차원에서 cron과 동일한 기능을 제공하는 경우, 해당 API를 사용할 수 있다. e.g. Java Executors API

job을 작성할 때의 주의사항은 [Batch job 작성 시 유의사항](/situations-and-patterns/batch-job.md)을 보도록 하자.

## Queue & Worker

서버에서 처리해야 하는 태스크를 큐에 던지고, 워커가 해당 태스크를 큐에서 뽑아서 처리하는 형식의 패턴이다.

큐를 이용하면 다음과 같은 장점을 얻을 수 있다.

- 트래픽의 분산 - 큐를 사용하면 트래픽의 집중으로 인한 서버 부하를 어느정도 완화시킬 수 있다. 워커의 처리량을 상회하는 양의 트래픽이 들어올 경우, 큐가 넘치는 트래픽을 잠시 버퍼링해줄 수 있다. 트래픽의 피크 시간이 끝나고 워커의 처리량이 트래픽의 인입량을 넘어서게 되면 다시 큐의 사이즈가 줄어들게 될 것이다.
- 편리한 scale out/in - 외부 트래픽을 수신하는 API 서버는 많은 API를 노출하고, 다양한 로직을 처리하고 있을 가능성이 높다. 따라서 특정 작업 때문에 API 서버를 스케일링하는 것은 느리고 비효율적일 수 있다. 큐와 워커를 사용하면 특정 작업만 처리하는 서버만을 정확히 타겟팅하여 스케일링할 수 있어 보다 빠르고 효율적인 스케일링이 가능하다.
- 큐의 다양한 기능 사용 가능 - 일부 큐는 처리 시간을 딜레이 시켜주는 등의 편리한 기능을 제공한다. 큐와 워커를 사용하면 이런 기능을 십분 활용하여 더 다양한 요구사항을 간편하게 만족할 수 있게 된다.

그렇다고 큐가 항상 만능인 것은 아니다. 기본적으로 큐를 사용한다는 것은 작업을 비동기적으로 처리하겠다는 의미다. 어플리케이션의 특성에 따라 비동기적으로 처리하는 게 자연스러운 작업도 있고, 그렇지 않은 작업도 있을 것이다. 비동기적으로 처리되면 안 되는 작업에는 큐를 사용하는 게 적합하지 않다.

## Background Task

서버에서 처리해야 하는 작업을 다른 쓰레드에 던져 백그라운드에서 처리하는 패턴이다.

백그라운드 태스크와 큐&워커는 얼핏 보면 비동기 작업을 처리하기 위한 방법으로 유사해보일 수 있지만, 실제로 활용해보면 둘의 유사성은 그리 크지 않다.

- 백그라운드 태스크는 작업의 "비동기성"에 초점을 맞춘다. API 요청을 받았을 때 응답을 빠르게 돌려주기 위해 일부 비동기적으로 처리해도 되는 로직을 다른 쓰레드로 던지는 것이다.
- 반면 큐와 워커는 비동기성도 중요하긴 하지만, 위의 언급된 큐와 워커의 다른 장점을 노리고 사용하는 경우가 많다. 단순히 작업을 비동기적으로 처리하는 것만을 위해 큐와 워커를 사용하기에는 비용이 너무 많이 든다. 큐와 워커를 띄워야 하고, 워커를 띄우려면 코드도 기존 서버로부터 분리해내야 한다.

백그라운드 태스크를 사용할 때 주의해야 할 점은 쓰레드 관리이다. 작업을 실행시키려는 쓰레드가 어떤 풀에서 관리되고 있는지, 해당 풀의 사이즈는 어떤 로직으로 결정되는지 등에 주의하자.
